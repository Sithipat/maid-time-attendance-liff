<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>ลงเวลา (ทำความสะอาด)</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    body{font-family:-apple-system,'TH Sarabun New',sans-serif;padding:16px}
    .btn{display:inline-block;padding:12px 16px;border-radius:12px;border:1px solid #ddd;margin:6px 6px 0 0}
    .p{white-space:pre-wrap;background:#f7f7f7;border:1px solid #eee;border-radius:10px;padding:12px}
    .ok{background:#0a7; color:#fff; border-color:#0a7}
    .err{background:#d33; color:#fff; border-color:#d33}
  </style>
</head>
<body>
  <h2>ลงเวลา (ทำความสะอาด)</h2>
  <p id="status">บันทึกลงเหลว</p>

  <button id="openInLine" class="btn">เปิดผ่าน LIFF URL</button>
  <div id="hello" style="margin:10px 0;"></div>

  <button id="btnIn"  class="btn ok">บันทึกเข้างาน</button>
  <button id="btnOut" class="btn">บันทึกออกงาน</button>

  <div class="p" id="log"></div>

<script>
(async () => {
  const LOG = (x)=>{ document.getElementById('log').textContent += (x+'\n'); };
  const show  = (id, html)=> document.getElementById(id).innerHTML = html;

  // !!! เปลี่ยนเป็น URL /exec ของคุณ แล้วอย่าเว้นบรรทัด !!!
  const EXEC_URL = "https://script.google.com/macros/s/AKfycbxNAPuaH6bpxpiijwr1lVY3Tr-vJyvamflq0jxeOjZ3ntvnli3Qy5MolxA-mOiDdEIkvg/exec".trim();

  // 1) init LIFF
  try{
    LOG('เริ่ม liff.init...');
    await liff.init({ liffId: "2008455173-vPVj00OY" });
    LOG('liff.init OK');
  }catch(e){
    LOG('liff.init error: ' + e);
  }

  // 2) login (ถ้าไม่ login)
  if(!liff.isLoggedIn()){
    show('status','ยังไม่ Login');
  }else{
    const prof = await liff.getProfile();
    show('hello', 'สวัสดี ' + prof.displayName);
  }

  // 3) utility ขอพิกัด
  async function getGPS(){
    return new Promise((resolve,reject)=>{
      navigator.geolocation.getCurrentPosition(
        pos => resolve({
          lat: pos.coords.latitude,
          lng: pos.coords.longitude,
          acc: pos.coords.accuracy
        }),
        err => reject(err),
        { enableHighAccuracy:true, timeout:15000, maximumAge:0 }
      );
    });
  }

  // 4) ส่ง POST ไปที่ Apps Script (ไม่ใช้ new URL)
  async function punch(type){
    try{
      const prof = await liff.getProfile();
      const uid  = prof.userId;
      const name = prof.displayName;
      const gps  = await getGPS();

      LOG(`GPS lat=${gps.lat}, lng=${gps.lng}, acc=${gps.acc}m`);

      const payload = {
        action: 'punch',
        type,                // 'IN' | 'OUT'
        uid,
        name,
        gps
      };

      const res = await fetch(EXEC_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload),
        // ไม่ต้องตั้ง mode/no-cors เพื่อให้สามารถอ่าน JSON กลับมาได้
        redirect: 'follow',
        credentials: 'omit'
      });

      // ถ้า Apps Script ตอบ JSON กลับมา
      const data = await res.json();
      if(data.ok){
        show('status', (type==='IN'?'บันทึกเข้าเรียบร้อย':'บันทึกออกเรียบร้อย'));
        LOG(JSON.stringify(data));
      }else{
        show('status', 'บันทึกล้มเหลว');
        LOG('Server not ok: ' + JSON.stringify(data));
      }
    }catch(e){
      show('status','บันทึกล้มเหลว');
      LOG('ERROR: ' + e);
    }
  }

  document.getElementById('btnIn').onclick  = ()=> punch('IN');
  document.getElementById('btnOut').onclick = ()=> punch('OUT');

  // ปุ่มเปิดด้วย LIFF URL (กันกรณีเปิดผ่าน browser ปกติ)
  document.getElementById('openInLine').onclick = ()=>{
    const liffUrl = "https://liff.line.me/2008455173-vPVj00OY";
    window.location.href = liffUrl;
  };

})();
</script>
</body>
</html>
